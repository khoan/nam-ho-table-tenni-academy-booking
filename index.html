<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Booking - Nam Ho Table Tennis Academy</title>
  <link rel="stylesheet" href="tachyons.css"/>
  <style>
input[type=radio]:checked+label {
  color: rgba(255,255,255,0.9);
  background-color: rgba(0,0,0,0.8);
}
  </style>
</head>
<body>
  <main>
    <div class="ph4 ph5-m ph6-l">
      <div class="pv5 f4 f2-ns measure center">
        <h1 class="fw6 f1 fl w-100 black-70 mt0 mb3 avenir">Booking</h1>

        <form accept-charset="utf-8">
          <fieldset id="sign_up" class="ba b--transparent ph0 mh0">
            <legend class="ph0 mh0 fw6 clip">Booking</legend>
            <div class="mt4">
              <label class="db fw4 lh-copy f4 black-60" for="name">Your Name</label>
              <input class="pa2 input-reset ba bg-transparent b--black-40" type="text" name="name" id="name">
            </div>
            <div class="mt4">
              <label class="db fw4 lh-copy f4 black-60" for="contact">Your Contact Number</label>
              <input class="pa2 input-reset ba bg-transparent b--black-40" type="text" name="contact" id="contact">
            </div>
          </fieldset>
          <fieldset class="mt3 bn ph0">
            <legend class="f4 fw4 black-60">Date</legend>
            <div id="js-session_dates"></div>
          </fieldset>
          <fieldset class="mt3 bn ph0">
            <legend class="f4 fw4 black-60">Time</legend>
            <div id="js-session_times"></div>
          </fieldset>
          <div class="mt5">
            <input class="pointer dim ph4 pv2 mb2 dib white bg-dark-blue" type="submit" value="Book">
          </div>
        </form>
      </div>
    </div>
    
    <div class="vh-75 cover bg-center" style="background-image: url(banner.jpg);"></div>
  </main>

  <footer class="pv4 ph3 ph5-m ph6-l mid-gray">
    <small class="f6 db tc">1/5 Clyde Street, Rydalmere, NSW, 2116</small>
    <div class="tc mt3">
      <a href="mailto:ssook6880@gmail.com" class="js-email mid-gray link dib dim ph2 pb1 lh-solid">
        <svg class="dib" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
        </svg>
        <span class="dib fw6" style="font-size: 12px;">Sue</span>
      </a>
    </div>
  </footer>
  <script type="module">
    import { el, list, mount } from "./redom.js";

    class SessionDate {
      update({ label, value }) {
        const inputId = `session-${label.day}`;

        this.el = el(".dib.mr3",
          el(".flex.items-center",
            el("input.dn", {type: "radio", name: "session_date", id: inputId, value}),
            el("label.ba.ph3.pv2.b--black-40.pointer", {for: inputId},
              [
                el(".f4.tc", label.day),
                el(".f5", label.date)
              ]
            )
          )
        );
      }
    }

    class SessionTime {
      update({ label, value }) {
        const inputId = `session-${value}`;

        this.el = el(".dib.mr3",
          el(".flex.items-center",
            el("input.dn", {type: "radio", name: "session[time]", id: inputId, value}),
            el("label.ba.ph3.pv2.b--black-40.pointer", {for: inputId},
              el(".f4.tc", label)
            )
          )
        );
      }
    }

    const SessionDictionary = {
      Mon: [16,18,20,22],
      Tue: [16,18,20,22],
      Wed: [16,18,20,22],
      Thu: [16,18,20,22],
      Fri: [16,18,20,22],
      Sat: [14,16,18],
      Sun: [14,16,18],
    };
    const startDate = new Date;
    const advancedBookingDays = 2;

    class SessionPickerApp {
      constructor({ SessionDictionary, startDate, advancedBookingDays, locale, targets }) {
        this.defaultLocale = locale;
        this.defaultLocale || (this.defaultLocale = 'en-AU');

        this.SessionDictionary = SessionDictionary;
        this.defaultStartDate = startDate;
        this.advancedBookingDays = advancedBookingDays;

        this.targetDateEl = document.getElementById(targets.sessionDateId);
        this.targetTimeEl = document.getElementById(targets.sessionTimeId);

        this.availableDatesEl = list("div", SessionDate);
        this.availableTimesEl = list(el(".f4", "Please pick a date"), SessionTime, "value");

        mount(this.targetDateEl, this.availableDatesEl);
        mount(this.targetTimeEl, this.availableTimesEl);
      }

      listen() {
        this.targetDateEl.addEventListener('click', this.showAvailableTimes.bind(this));
      }

      // private

      showAvailableDates() {
        this.availableDatesEl.update(
          this.availableDates(this.startDate)
        );
      }

      showAvailableTimes(eventData) {
        if (eventData.target && !eventData.target.matches('input[type="radio"]')) return;

        this.availableTimesEl.update(
          this.availableTimes(
            this.SessionDictionary[eventData.target.value]
          )
        );
      }

      availableDates(startDate) {
        const result = [];

        let dateTime = startDate;
        for (let i = -1; i < this.advancedBookingDays; i++) {
          result.push({
            label: {
              day: this.format(dateTime, 'longWeekday'),
              date: this.format(dateTime, 'ddmmmyyyy')
            },
            value: this.format(dateTime, 'shortWeekday')
          });

          dateTime = this.nextDate(dateTime);
        }

        return result;
      }

      availableTimes(times) {
        const result = [];

        let dateTime = new Date;
        for(let i = 0; i < times.length;) {
          const j = i + 1;

          if (!times[j]) break;

          const label = `${this.format(dateTime.setHours(times[i]), 'hourOfDay').replace(' ', '')} - ${this.format(dateTime.setHours(times[j]), 'hourOfDay').replace(' ', '')}`;

          result.push({ label, value: times[i]} );

          i = j;
        }

        return result;
      }

      get startDate() {
        if (this.defaultStartDate) {
          return this.defaultStartDate;
        }

        const today = new Date;
        if (this.canBook(today)) {
          return today;
        } else {
          return this.nextDate(today);
        }
      }

      canBook(dateTime) {
        const hour = dateTime.getHours();
        const day = this.format(dateTime, 'shortWeekday');

        return this.SessionDictionary[day].some((sessionHour) => hour < sessionHour);
      }

      nextDate(dateTime) {
        const dayAfter = new Date(dateTime);
        dayAfter.setDate(dateTime.getDate() + 1);

        return dayAfter;
      }

      format(dateTime, style, locale) {
        switch(style) {
          case 'hourOfDay':
            style = { hour: 'numeric' };
            break;

          case 'shortWeekday':
            style = { weekday: 'short'};
            break;

          case 'longWeekday':
            style = { weekday: 'long'};
            break;

          case 'ddmmmyyyy':
          default:
            style = { day: 'numeric', month: 'short', year: 'numeric' };
            break;
        }

        locale || (locale = this.defaultLocale);

        return new Intl.DateTimeFormat(locale, style).format(dateTime);
      }
    }

    const app = new SessionPickerApp({
      SessionDictionary,
      startDate,
      advancedBookingDays,
      targets: {
        sessionDateId: "js-session_dates",
        sessionTimeId: "js-session_times",
      }
    });
    app.showAvailableDates();
    app.listen();
    console.log('start date', app.startDate);
    console.log('available dates', app.availableDates(app.startDate));
    console.log('available times', app.availableTimes(SessionDictionary['Sun']));
  </script>
</body>
</html>
